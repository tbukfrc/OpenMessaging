let socket=io.connect("messageservices.tbuk.site"),progressBar=document.getElementById("srvload"),regusername,logusername,username,password,currentUploadKey="",lowBandwidth=!1,extData,currentData="",doneLoading=!1;function replaceURLs(e){if(e)return e.replace(/(((https?:\/\/)|(www\.))[^\s]+)/g,function(e){var t=e;return t.match("^https?://")||(t="http://"+t),'<a href="'+t+'" target="_blank" rel="noopener noreferrer">'+e+"</a>"})}function strip_tags(e,...t){return e.replace(/<(\/?)(\w+)[^>]*\/?>/g,(e,n,s)=>t.includes(s)?"<"+n+s+">":"").replace(/<!--.*?-->/g,"")}function download(e,t){let n=document.createElement("a");n.setAttribute("href","data:application/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}function removeTyping(e){document.getElementById(`typing${e}`).remove()}function spawnPopup(){if(null!=document.getElementById("warning")&&(document.getElementById("warning").remove(),document.getElementById("code").remove()),parseInt(extData.ver.replace(".",""))<parseInt(localStorage.getItem("localVersion").replace(".",""))?document.getElementById("desc").innerHTML=`Warning! This theme/extension was created in version ${extData.ver}. Your current client version is ${localStorage.getItem("localVersion")}. It may behave unexpectedly!`:document.getElementById("desc").innerHTML="","omext"==extData.id){let e=document.getElementById("extensionBox"),t=document.createElement("code");t.innerHTML=extData.customJS.replace(String.raw`\n`,"<br>"),t.id="code",e.prepend(t);let n=document.createElement("p");n.innerHTML="Warning! Extensions have lots of power, and can leak account information. Please review the code below, and only install extensions you trust.",n.id="warning",e.prepend(n)}document.getElementById("title").innerHTML=`"${extData.name}"`,document.getElementById("extensionBox").showModal()}function chunkString(e,t){return e.match(RegExp(".{1,"+t+"}","g"))}function sendMsg(e){if(console.log("sending message"),document.getElementsByClassName("imgPreviewDiv").length>=1&&currentUploadKey.length>5){let t=document.getElementsByClassName("imgPreview")[0],n;data=chunkString(n=currentData.length>3?currentData:t.src,5e4);let s=document.createElement("progress");s.id="fileUploadProgress",s.max=1,s.value=0,document.body.appendChild(s);let l=data.length,a=0;document.getElementById("msginput").disabled=!0,document.getElementById("send").disabled=!0;let i=setInterval(()=>{if(a>l){clearInterval(i),socket.emit("dataSend",{part:"transferComplete",id:currentUploadKey}),socket.emit("recieve_msg",{msg:e,dataid:currentUploadKey}),currentUploadKey="",document.getElementById("msginput").value="",document.getElementsByClassName("imgPreviewDiv")[0].remove(),document.getElementById("msginput").disabled=!1,document.getElementById("send").disabled=!1,s.remove();return}console.log(a),console.log(l),socket.emit("dataSend",{part:data[a],id:currentUploadKey}),s.value=a/data.length,a++},1)}else if(document.getElementsByClassName("imgPreviewDiv").length>=1&&currentUploadKey.length<3){socket.emit("requestUploadKey");return}else socket.emit("recieve_msg",{msg:e,dataid:!1}),document.getElementById("msginput").value=""}function setImageHeight(){document.getElementById("customImageSize")&&document.getElementById("customImageSize").remove();let e=document.createElement("style");e.id="customImageSize",e.innerHTML=`
  .imgAttachment {
  height: ${document.getElementById("imageSize").value} !important;
  }
  `,document.head.appendChild(e)}function setCustomCss(){document.getElementById("userCss")&&document.getElementById("userCss").remove();let e=document.createElement("style");e.id="userCss",e.innerHTML=document.getElementById("customCss").value,document.head.appendChild(e)}function setCustomJS(){document.getElementById("userJS")&&document.getElementById("userJS").remove();let e=document.createElement("script");e.id="userJS",e.innerHTML=editor.getValue(),document.head.appendChild(e)}function openFiles(e){if(0==!document.getElementsByClassName("imgPreviewDiv").length)return;document.getElementById("messageBox").className="animateUp";let t=Array.from(e.files);for(let n=0;n<e.files.length;n++){fileId=document.getElementsByClassName("imgPreviewDiv").length+1;let s=document.createElement("div");s.className="imgPreviewDiv",s.id=`imgPreviewDiv${fileId}`;let l=document.createElement("button");l.className="fileDeleteButton",l.addEventListener("click",()=>{console.log(document.getElementsByClassName("imgPreviewDiv").length),document.getElementsByClassName("imgPreviewDiv").length-1<1&&(document.getElementById("messageBox").className="animateDown"),t.splice(fileId,1),s.remove()}),l.innerHTML='<svg class=fileDeleteIco xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g data-name="Layer 2"><path d="m13.41 12 4.3-4.29a1 1 0 1 0-1.42-1.42L12 10.59l-4.29-4.3a1 1 0 0 0-1.42 1.42l4.3 4.29-4.3 4.29a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0l4.29-4.3 4.29 4.3a1 1 0 0 0 1.42 0 1 1 0 0 0 0-1.42z" data-name="close"/></g></svg>',s.appendChild(l);let a=document.getElementById("fileUpload").value;console.log(a);let i=new FileReader,m;i.onload=e=>{a.includes("omtheme")||a.includes("omext")?((m=document.createElement("p")).innerHTML=a,currentData=e.target.result,m.className="imgPreview",s.appendChild(m),document.body.appendChild(s)):((m=document.createElement("img")).src=e.target.result,m.className="imgPreview",s.appendChild(m),document.body.appendChild(s))},a.includes("omtheme")||a.includes("omext")?i.readAsText(t[n]):i.readAsDataURL(t[n])}}socket.on("connect",()=>{socket.emit("browserSafari",!1)}),socket.on("disconnect",()=>{location.reload()}),socket.on("msgDist",e=>{let t=document.getElementById("messageBox"),n=document.createElement("div");n.className="msgbox";let s=document.createElement("p");s.innerHTML=`<span class=${e.color}>${e.author}</span>: `,s.className="msgtxt";let l=document.createElement("span");if(l.id="messageContent",l.innerHTML=replaceURLs(e.content),s.append(l),e.attachments&&!lowBandwidth){let a=document.createElement("div");a.className="imageAttachment",a.innerHTML=e.attachments,s.append(a)}else if(e.attachments&&lowBandwidth){let i=document.createElement("div");i.className="imageAttachment",i.innerHTML="<div class=imgAttachment><h2>Low bandwidth mode enabled</h2><br><p>Please disable low bandwidth mode to see images</p></div>",s.append(i)}e.timestamp&&(n.addEventListener("mouseenter",()=>{document.getElementById("timestampDiv")&&document.getElementById("timestampDiv").remove();let t=e.timestamp,s=new Date(t+="Z").toLocaleString(),l=document.createElement("div");l.innerHTML=`<p id=timestampDivText>${s}</p>`,l.id="timestampDiv",n.appendChild(l)}),n.addEventListener("mouseleave",()=>{document.getElementById("timestampDiv").remove()})),(e.author==logusername||e.author==regusername)&&(n.addEventListener("mouseenter",()=>{document.getElementById("messageToolDiv")&&document.getElementById("messageToolDiv").remove();let t=document.createElement("div");t.innerHTML="<button id=editMessage>Edit</button><button id=deleteMessage>Delete</button>",t.id="messageToolDiv",n.appendChild(t),document.getElementById("editMessage").addEventListener("click",()=>{if(!document.getElementById("editInput")){let t=e.content;l.remove();let n=document.createElement("input");n.id="editInput",n.value=t,n.addEventListener("keyup",t=>{"Enter"===t.key&&socket.emit("editMessage",e.id,n.value)}),s.appendChild(n)}}),document.getElementById("deleteMessage").addEventListener("click",()=>{socket.emit("deleteMessage",e.id)})}),n.addEventListener("mouseleave",()=>{document.getElementById("messageToolDiv").remove()})),n.appendChild(s),t.appendChild(n),t.scrollTop=t.scrollHeight}),socket.on("userTyping",e=>{if(document.getElementById(`typing${e}`));else if(e===regusername||e===logusername);else{let t=document.createElement("div"),n=document.createElement("p");t.id=`typing${e}`,n.innerText=`${e} is typing...`,t.className="typingIndDiv",t.appendChild(n),document.body.appendChild(t),setTimeout(removeTyping,5e3,e)}}),socket.on("serverLoad",e=>{document.getElementById("progressDiv").remove()}),socket.on("messageHistory",e=>{doneLoading=!1;let t=document.getElementById("messageBox");t.innerHTML="";for(let n=0;n<e.length;n++){let s=document.createElement("div");s.className="msgbox";let l=document.createElement("p");l.innerHTML=`<span class=${e[n].color}>${e[n].author}</span>: `,l.className="msgtxt";let a=document.createElement("span");if(a.id="messageContent",a.innerHTML=replaceURLs(e[n].content),l.append(a),e[n].attachments&&!lowBandwidth){let i=document.createElement("div");i.className="imageAttachment",i.innerHTML=e[n].attachments,l.append(i)}else if(e[n].attachments&&lowBandwidth){let m=document.createElement("div");m.className="imageAttachment",m.innerHTML="<div class=imgAttachment><h2>Low bandwidth mode enabled</h2><br><p>Please disable low bandwidth mode to see images</p></div>",l.append(m)}e[n].timestamp&&(s.addEventListener("mouseenter",()=>{document.getElementById("timestampDiv")&&document.getElementById("timestampDiv").remove();let t=e[n].timestamp,l=new Date(t+="Z").toLocaleString(),a=document.createElement("div");a.innerHTML=`<p id=timestampDivText>${l}</p>`,a.id="timestampDiv",s.appendChild(a)}),s.addEventListener("mouseleave",()=>{document.getElementById("timestampDiv").remove()})),(e[n].author==logusername||e[n].author==regusername||"admin"==logusername)&&(s.addEventListener("mouseenter",()=>{document.getElementById("messageToolDiv")&&document.getElementById("messageToolDiv").remove();let t=document.createElement("div");t.innerHTML="<button id=editMessage>Edit</button><button id=deleteMessage>Delete</button>",t.id="messageToolDiv",s.appendChild(t),document.getElementById("editMessage").addEventListener("click",()=>{if(!document.getElementById("editInput")){let t=e[n].content;a.remove();let s=document.createElement("input");s.id="editInput",s.value=t,s.addEventListener("keyup",t=>{"Enter"===t.key&&socket.emit("editMessage",e[n].id,s.value)}),l.appendChild(s)}}),document.getElementById("deleteMessage").addEventListener("click",()=>{console.log("deleted: "+e[n].id),socket.emit("deleteMessage",e[n].id)})}),s.addEventListener("mouseleave",()=>{document.getElementById("messageToolDiv").remove()})),s.appendChild(l),t.appendChild(s)}t.scrollTop=t.scrollHeight,doneLoading=!0}),socket.on("recieveRooms",e=>{if(document.getElementsByClassName("roomListing"))for(;document.getElementsByClassName("roomListing").length>0;)for(let t=0;t<document.getElementsByClassName("roomListing").length;t++)document.getElementsByClassName("roomListing")[0].remove();for(let n in e){let s=document.createElement("div");e[n].protected?(s.innerHTML=`<p>${e[n].name}</p><svg class=lockIco xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17,9V7A5,5,0,0,0,7,7V9a3,3,0,0,0-3,3v7a3,3,0,0,0,3,3H17a3,3,0,0,0,3-3V12A3,3,0,0,0,17,9ZM9,7a3,3,0,0,1,6,0V9H9Zm9,12a1,1,0,0,1-1,1H7a1,1,0,0,1-1-1V12a1,1,0,0,1,1-1H17a1,1,0,0,1,1,1Z"/></svg>`,s.addEventListener("click",()=>{document.getElementById("openRoomBrowser").click(),document.getElementById("msginput").value=`/joinroom ${e[n].name} {pass}`})):(s.innerHTML=`<p>${e[n].name}</p>`,s.addEventListener("click",()=>{document.getElementById("openRoomBrowser").click(),document.getElementById("msginput").value=`/joinroom ${e[n].name}`,sendMsg(document.getElementById("msginput").value),document.getElementById("msginput").value=""})),s.className="roomListing",document.getElementById("roomBrowser").appendChild(s)}}),socket.on("statusCallback",e=>{if(e.error)document.getElementById("errorText").innerHTML=`Error: ${e.error}
Description: ${e.description}`,document.getElementById("errorBox").showModal();else if(e.status){if("accountCreated"===e.status||"accountLogin"===e.status){document.getElementById("registerBox").close(),document.getElementById("loginBox").close(),document.getElementById("registerBtn").remove(),document.getElementById("loginBtn").remove(),document.getElementById("registerLoginDiv").remove(),document.getElementById("blurFilter").remove(),localStorage.getItem("username")&&localStorage.getItem("password")||(localStorage.setItem("username",username),localStorage.setItem("password",password));let t=document.createElement("button");t.id="settingsButton",t.innerHTML='<svg id=settingsIco xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><path d="M27.526 12.682a11.906 11.906 0 0 0-1.028-2.492l1.988-4.182a16.159 16.159 0 0 0-2.494-2.494L21.81 5.502a11.97 11.97 0 0 0-2.492-1.028L17.762.102C17.184.038 16.596 0 16 0s-1.184.038-1.762.102l-1.556 4.372c-.874.252-1.71.596-2.49 1.028L6.008 3.514a16.159 16.159 0 0 0-2.494 2.494l1.988 4.182a11.97 11.97 0 0 0-1.028 2.492L.102 14.238C.038 14.816 0 15.404 0 16s.038 1.184.102 1.762l4.374 1.556c.252.876.594 1.71 1.028 2.492l-1.988 4.182c.738.92 1.574 1.758 2.494 2.494l4.182-1.988c.78.432 1.616.776 2.492 1.028L14.24 31.9c.576.062 1.164.1 1.76.1s1.184-.038 1.762-.102l1.556-4.374c.876-.252 1.71-.594 2.492-1.028l4.182 1.988a16.071 16.071 0 0 0 2.494-2.494l-1.988-4.182a11.97 11.97 0 0 0 1.028-2.492L31.9 17.76c.062-.576.1-1.164.1-1.76s-.038-1.184-.102-1.762l-4.372-1.556zM16 24a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm-4-8a4 4 1080 1 0 8 0 4 4 1080 1 0-8 0z"/></svg>',t.addEventListener("click",()=>{document.getElementById("userSettings").showModal()}),document.getElementById("inputDiv").prepend(t),document.getElementById("msginput").addEventListener("keyup",()=>{socket.emit("amTyping")}),socket.emit("requestUpdate"),localStorage.getItem("localVersion")?socket.emit("versionNum",localStorage.getItem("localVersion")):socket.emit("versionNum","getLatest")}}else e.popup?(document.getElementById("statusText").innerHTML=`Status: ${e.popup}
Description: ${e.description}`,document.getElementById("statusBox").showModal()):e.changelog&&(localStorage.setItem("localVersion",e.changelog),document.getElementById("changeText").innerHTML=`V${e.changelog}

${e.description}`,document.getElementById("changeBox").showModal())}),socket.on("uploadKeyCallback",e=>{currentUploadKey=e,sendMsg(document.getElementById("msginput").value)}),window.onload=function(){document.getElementById("customBColor").value="#333333",document.getElementById("customHColor").value="#2C2C2C",document.getElementById("customAColor").value="#D3D3D3",document.getElementById("exportId").value="New Theme",document.getElementById("extId").value="New Extension";let e=document.querySelector(":root");if(null!==localStorage.getItem("background")){let t=localStorage.getItem("background");e.style.setProperty("--background",t),document.getElementById("customBColor").value=t}if(null!==localStorage.getItem("extensions")){let n=JSON.parse(localStorage.getItem("extensions"));for(let s in n){let l=document.getElementById("exts"),a=document.createElement("div");a.className="extDiv";let i=document.createElement("p");i.innerText=n[s].name,i.className="extensionName";let m=document.createElement("script");m.className="JSextension",m.innerHTML=n[s].customJS;let d=document.createElement("button");d.className="extRemoveButton",d.innerHTML="Delete",d.addEventListener("click",()=>{m.remove(),i.remove(),a.remove();let e=JSON.parse(localStorage.getItem("extensions"));e.pop(s),localStorage.setItem("extensions",JSON.stringify(e)),d.remove()}),document.head.appendChild(m),a.append(i),a.append(d),l.append(a)}}else localStorage.setItem("extensions",JSON.stringify([]));if(null!==localStorage.getItem("highlight")){let o=localStorage.getItem("highlight");e.style.setProperty("--highlight",o),document.getElementById("customHColor").value=o}if(null!==localStorage.getItem("accent")){let r=localStorage.getItem("accent");e.style.setProperty("--accent",r),document.getElementById("customAColor").value=r}if(null!==localStorage.getItem("mediaHeight")){let g=localStorage.getItem("mediaHeight");document.getElementById("imageSize").value=g,setImageHeight()}if(null!==localStorage.getItem("customCss")){let c=localStorage.getItem("customCss");document.getElementById("customCss").value=c,setCustomCss()}if(null!==localStorage.getItem("customJS")){let u=localStorage.getItem("customJS");editor.setValue(u),setCustomJS()}if(null!==localStorage.getItem("lowBandwidth")){let p=JSON.parse(localStorage.getItem("lowBandwidth"));lowBandwidth=p,document.getElementById("bandCheck").checked=p}document.getElementById("saveSettings").addEventListener("click",()=>{localStorage.setItem("mediaHeight",document.getElementById("imageSize").value),localStorage.setItem("customCss",document.getElementById("customCss").value),localStorage.setItem("customJS",editor.getValue()),setImageHeight(),setCustomCss(),setCustomJS()}),document.getElementById("importTheme").addEventListener("click",()=>{document.getElementById("uploadCustom").click()}),document.getElementById("importExtension").addEventListener("click",()=>{document.getElementById("uploadCustom").click()}),document.getElementById("uploadCustom").addEventListener("change",e=>{let t=new FileReader;t.onload=e=>{extData=JSON.parse(e.target.result),spawnPopup()},t.readAsText(e.target.files[0])}),document.getElementById("confirmLoad").addEventListener("click",()=>{if("omtheme"==extData.id)localStorage.setItem("background",extData.background||"#333"),localStorage.setItem("accent",extData.accent||"#D3D3D3"),localStorage.setItem("highlight",extData.highlight||"#2C2C2C"),localStorage.setItem("customCss",extData.css||""),window.location.reload();else if("omext"==extData.id){let e=JSON.parse(localStorage.getItem("extensions"));e.push(extData),localStorage.setItem("extensions",JSON.stringify(e)),window.location.reload()}}),document.getElementById("exportTheme").addEventListener("click",()=>{let e={id:"omtheme",name:document.getElementById("exportId").value,ver:localStorage.getItem("localVersion")||"1.0.0",background:localStorage.getItem("background")||"#333",highlight:localStorage.getItem("highlight")||"#2C2C2C",accent:localStorage.getItem("accent")||"#D3D3D3",css:localStorage.getItem("customCss")||!1};download(`${document.getElementById("exportId").value}.omtheme`,e)}),document.getElementById("exportExtension").addEventListener("click",()=>{let e={id:"omext",name:document.getElementById("extId").value,ver:localStorage.getItem("localVersion")||"1.0.0",description:document.getElementById("extDesc").value,customJS:editor.getValue()};download(`${document.getElementById("extId").value}.omext`,e)}),document.getElementById("bandCheck").addEventListener("change",()=>{let e=document.getElementById("bandCheck").checked;lowBandwidth=e,localStorage.setItem("lowBandwidth",JSON.stringify(e)),socket.emit("requestUpdate")}),document.getElementById("customBColor").addEventListener("change",()=>{let t=document.getElementById("customBColor").value;e.style.setProperty("--background",t),localStorage.setItem("background",t)}),document.getElementById("customHColor").addEventListener("change",()=>{let t=document.getElementById("customHColor").value;e.style.setProperty("--highlight",t),localStorage.setItem("highlight",t)}),document.getElementById("customAColor").addEventListener("change",()=>{let t=document.getElementById("customAColor").value;e.style.setProperty("--accent",t),localStorage.setItem("accent",t)}),document.getElementById("openRoomBrowser").addEventListener("click",()=>{let e=document.getElementById("roomBrowser");(-1!==navigator.userAgent.indexOf("iPhone")||-1!==navigator.userAgent.indexOf("Android")||-1!==navigator.userAgent.indexOf("Windows Phone"))&&(e.style.width="99vw",document.getElementById("titleBreak").style.width="99vw"),"close"==e.className||"load"==e.className?e.className="open":e.className="close"}),document.getElementById("fileUpload").addEventListener("change",e=>{openFiles(e.target)}),document.getElementById("fileClick").addEventListener("click",()=>{document.getElementById("fileUpload").click()}),localStorage.getItem("username")&&localStorage.getItem("password")&&(socket.emit("login",localStorage.getItem("username"),localStorage.getItem("password")),logusername=localStorage.getItem("username")),document.querySelector("#send").addEventListener("click",()=>{sendMsg(document.getElementById("msginput").value)}),document.getElementById("registerBtn").addEventListener("click",()=>{document.getElementById("registerBox").showModal()}),document.getElementById("loginBtn").addEventListener("click",()=>{document.getElementById("loginBox").showModal()}),document.getElementById("register").addEventListener("click",()=>{regusername=document.getElementById("username").value;let e=document.getElementById("password").value;username=regusername,password=e,socket.emit("register_account",regusername,e)}),document.getElementById("login").addEventListener("click",()=>{logusername=document.getElementById("logusername").value;let e=document.getElementById("logpassword").value;username=logusername,password=e,socket.emit("login",logusername,e)}),document.getElementById("password").addEventListener("keyup",e=>{if("Enter"===e.code){regusername=document.getElementById("username").value;let t=document.getElementById("password").value;username=regusername,password=t,socket.emit("register_account",regusername,t)}}),document.getElementById("logpassword").addEventListener("keyup",e=>{if("Enter"===e.code){logusername=document.getElementById("logusername").value;let t=document.getElementById("logpassword").value;username=logusername,password=t,socket.emit("login",logusername,t)}}),document.getElementById("msginput").addEventListener("keyup",e=>{"Enter"===e.code&&sendMsg(document.getElementById("msginput").value)}),document.getElementById("msginput").addEventListener("paste",e=>{e.clipboardData.files.length>0&&openFiles(e.clipboardData)})};